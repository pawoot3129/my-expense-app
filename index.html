<details>
<summary>คลิกเพื่อดู/ซ่อนโค้ดแอปพลิเคชัน (เวอร์ชันล่าสุด)</summary>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แอปจัดการรายรับ-รายจ่าย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 no-print">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-lg font-semibold text-gray-700">กำลังโหลดข้อมูล...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <header class="bg-white shadow-md rounded-lg p-4 mb-6 no-print">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-2xl md:text-3xl font-bold text-blue-600">สมุดบัญชีรายรับ-รายจ่าย</h1>
                <div class="text-xs text-gray-500 mt-2 md:mt-0">User ID: <span id="userId" class="font-mono"></span></div>
            </div>
            <nav class="mt-4 border-t pt-2 flex flex-wrap gap-2">
                <button id="nav-daily" class="px-4 py-2 rounded hover:bg-blue-100 font-semibold">รายวัน</button>
                <button id="nav-monthly" class="px-4 py-2 rounded bg-blue-500 text-white font-semibold">รายเดือน</button>
                <button id="nav-yearly" class="px-4 py-2 rounded hover:bg-blue-100 font-semibold">รายปี</button>
                <button id="nav-config" class="px-4 py-2 rounded hover:bg-blue-100 font-semibold">ตั้งค่าหมวดหมู่</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <!-- Left Column: Form -->
            <aside class="lg:col-span-2 bg-white shadow-md rounded-lg p-6 h-fit no-print">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2">บันทึกรายการใหม่</h3>
                <form id="transaction-form">
                    <div class="mb-4"><label class="block text-gray-700 mb-1">ประเภท</label><select id="transaction-type" class="w-full p-2 border rounded-lg bg-gray-50" required><option value="expense">รายจ่าย</option><option value="income">รายรับ</option></select></div>
                    <div class="mb-4"><label for="description" class="block text-gray-700 mb-1">คำอธิบาย</label><input type="text" id="description" class="w-full p-2 border rounded-lg" placeholder="เช่น ค่ากาแฟ, เงินเดือน" required></div>
                    <div class="mb-4"><label for="amount" class="block text-gray-700 mb-1">จำนวนเงิน</label><input type="number" id="amount" class="w-full p-2 border rounded-lg" placeholder="0.00" step="0.01" required></div>
                    <div class="mb-4"><label for="category" class="block text-gray-700 mb-1">หมวดหมู่</label><select id="category" class="w-full p-2 border rounded-lg bg-gray-50" required></select></div>
                    <div class="mb-4"><label for="date" class="block text-gray-700 mb-1">วันที่</label><input type="date" id="date" class="w-full p-2 border rounded-lg" required></div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300">บันทึกรายการ</button>
                </form>
            </aside>

            <!-- Right Column: Main Content -->
            <main id="main-content" class="lg:col-span-3 no-print">
                <!-- Daily View -->
                <div id="daily-view" class="hidden">
                    <div class="bg-white shadow-md rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">สรุปรายวัน</h2><button id="print-daily-report-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">พิมพ์รายงาน</button></div>
                        <div class="flex justify-center items-center mb-4"><input type="date" id="daily-date-picker" class="p-2 border rounded-lg"></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div class="bg-green-100 p-4 rounded-lg"><p class="text-lg text-green-800">รายรับ</p><p id="daily-total-income" class="text-2xl font-bold text-green-600">0.00</p></div>
                            <div class="bg-red-100 p-4 rounded-lg"><p class="text-lg text-red-800">รายจ่าย</p><p id="daily-total-expense" class="text-2xl font-bold text-red-600">0.00</p></div>
                            <div class="bg-blue-100 p-4 rounded-lg"><p class="text-lg text-blue-800">คงเหลือ</p><p id="daily-balance" class="text-2xl font-bold text-blue-600">0.00</p></div>
                        </div>
                    </div>
                    <div class="bg-white shadow-md rounded-lg p-6"><h3 class="text-xl font-semibold mb-4">รายการทั้งหมดในวันที่เลือก</h3><div id="daily-transaction-list" class="space-y-3 max-h-[30rem] overflow-y-auto pr-2"></div></div>
                </div>

                <!-- Monthly View -->
                <div id="monthly-view">
                    <div class="bg-white shadow-md rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">&lt; เดือนก่อน</button><h2 id="current-month-year" class="text-xl font-bold text-center"></h2><button id="next-month-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">เดือนถัดไป &gt;</button><button id="print-monthly-report-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">พิมพ์รายงาน</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div class="bg-green-100 p-4 rounded-lg"><p class="text-lg text-green-800">รายรับรวม</p><p id="monthly-total-income" class="text-2xl font-bold text-green-600">0.00</p></div>
                            <div class="bg-red-100 p-4 rounded-lg"><p class="text-lg text-red-800">รายจ่ายรวม</p><p id="monthly-total-expense" class="text-2xl font-bold text-red-600">0.00</p></div>
                            <div class="bg-blue-100 p-4 rounded-lg"><p class="text-lg text-blue-800">คงเหลือ</p><p id="monthly-balance" class="text-2xl font-bold text-blue-600">0.00</p></div>
                        </div>
                    </div>
                    <div class="bg-white shadow-md rounded-lg p-6 mb-6"><h3 class="text-xl font-semibold mb-4">สัดส่วนรายจ่าย (รายเดือน)</h3><canvas id="expense-chart"></canvas></div>
                    <div class="bg-white shadow-md rounded-lg p-6"><h3 class="text-xl font-semibold mb-4">รายการล่าสุด (รายเดือน)</h3><div id="monthly-transaction-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div></div>
                </div>

                <!-- Yearly View -->
                <div id="yearly-view" class="hidden">
                     <div class="bg-white shadow-md rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4"><button id="prev-year-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">&lt; ปีก่อน</button><h2 id="current-year" class="text-xl font-bold"></h2><button id="next-year-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ปีถัดไป &gt;</button><button id="print-yearly-report-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">พิมพ์รายงาน</button></div>
                        <div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">เดือน</th><th class="py-2 px-4 text-right">รายรับ</th><th class="py-2 px-4 text-right">รายจ่าย</th><th class="py-2 px-4 text-right">คงเหลือ</th></tr></thead><tbody id="yearly-summary-table"></tbody><tfoot class="bg-gray-200 font-bold"><tr><td class="py-2 px-4 text-left">รวมทั้งปี</td><td id="yearly-total-income" class="py-2 px-4 text-right"></td><td id="yearly-total-expense" class="py-2 px-4 text-right"></td><td id="yearly-balance" class="py-2 px-4 text-right"></td></tr></tfoot></table></div>
                    </div>
                </div>

                <!-- Config View -->
                <div id="config-view" class="hidden">
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div class="bg-white shadow-md rounded-lg p-6"><h3 class="text-xl font-semibold mb-4 text-green-600">หมวดหมู่รายรับ</h3><form id="add-income-category-form" class="flex gap-2 mb-4"><input type="text" id="new-income-category" class="flex-grow p-2 border rounded-lg" placeholder="เพิ่มหมวดหมู่รายรับใหม่" required><button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">+</button></form><ul id="income-category-list" class="space-y-2"></ul></div>
                      <div class="bg-white shadow-md rounded-lg p-6"><h3 class="text-xl font-semibold mb-4 text-red-600">หมวดหมู่รายจ่าย</h3><form id="add-expense-category-form" class="flex gap-2 mb-4"><input type="text" id="new-expense-category" class="flex-grow p-2 border rounded-lg" placeholder="เพิ่มหมวดหมู่รายจ่ายใหม่" required><button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">+</button></form><ul id="expense-category-list" class="space-y-2"></ul></div>
                   </div>
                </div>
            </main>
        </div>

        <!-- Modals -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40 no-print"><div class="bg-white rounded-lg p-8 w-full max-w-md m-4"><h2 class="text-2xl font-bold mb-4">แก้ไขรายการ</h2><form id="edit-form"><input type="hidden" id="edit-id"><div class="mb-4"><label class="block text-gray-700 mb-1">ประเภท</label><select id="edit-transaction-type" class="w-full p-2 border rounded-lg bg-gray-50" required><option value="expense">รายจ่าย</option><option value="income">รายรับ</option></select></div><div class="mb-4"><label for="edit-description" class="block text-gray-700 mb-1">คำอธิบาย</label><input type="text" id="edit-description" class="w-full p-2 border rounded-lg" required></div><div class="mb-4"><label for="edit-amount" class="block text-gray-700 mb-1">จำนวนเงิน</label><input type="number" id="edit-amount" class="w-full p-2 border rounded-lg" step="0.01" required></div><div class="mb-4"><label for="edit-category" class="block text-gray-700 mb-1">หมวดหมู่</label><select id="edit-category" class="w-full p-2 border rounded-lg bg-gray-50" required></select></div><div class="mb-4"><label for="edit-date" class="block text-gray-700 mb-1">วันที่</label><input type="date" id="edit-date" class="w-full p-2 border rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" id="cancel-edit" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">ยกเลิก</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">บันทึกการแก้ไข</button></div></form></div></div>
        <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 no-print"><div class="bg-white rounded-lg p-6 w-full max-w-sm m-4 text-center shadow-lg"><h3 class="text-lg font-bold mb-4 text-red-600">เกิดข้อผิดพลาด</h3><p id="alert-message" class="mb-6">ข้อความแจ้งเตือน</p><div class="flex justify-center"><button id="alert-ok-btn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">ตกลง</button></div></div></div>
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 no-print"><div class="bg-white rounded-lg p-6 w-full max-w-sm m-4 text-center shadow-lg"><h3 id="confirm-title" class="text-lg font-bold mb-4">ยืนยันการกระทำ</h3><p id="confirm-message" class="mb-6">คุณแน่ใจหรือไม่?</p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">ยกเลิก</button><button id="confirm-ok-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">ยืนยัน</button></div></div></div>

        <!-- Print Area -->
        <div id="print-area" class="hidden p-8"></div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
            import { getDatabase, ref, onValue, push, remove, set, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
            import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

            // *******************************************************************
            // *** ขั้นตอนสำคัญ: วาง Firebase Config ที่คัดลอกมาทับตรงนี้ ***
            // *******************************************************************
            const firebaseConfig = {
  apiKey: "AIzaSyBOasplUZOhUgqZqWLIrtQzYfA2Q1Nsxz0",
  authDomain: "accout-aad09.firebaseapp.com",
  databaseURL: "https://accout-aad09-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "accout-aad09",
  storageBucket: "accout-aad09.firebasestorage.app",
  messagingSenderId: "284200608229",
  appId: "1:284200608229:web:82ce20c2703c0494ce4f0c"
};

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const auth = getAuth(app);

            // --- Global State ---
            let currentUser = null;
            let monthlyDate = new Date();
            let yearlyDate = new Date().getFullYear();
            let allTransactions = [];
            let categories = { income: ['เงินเดือน', 'รายได้เสริม'], expense: ['อาหาร', 'เดินทาง', 'ที่อยู่อาศัย', 'ของใช้ส่วนตัว', 'บันเทิง'] };
            let expenseChart = null;

            // --- DOM Elements ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const userIdEl = document.getElementById('userId');
            const transactionForm = document.getElementById('transaction-form');
            const transactionTypeSelect = document.getElementById('transaction-type');
            const categorySelect = document.getElementById('category');
            const dateInput = document.getElementById('date');

            // Nav
            const navDaily = document.getElementById('nav-daily');
            const navMonthly = document.getElementById('nav-monthly');
            const navYearly = document.getElementById('nav-yearly');
            const navConfig = document.getElementById('nav-config');

            // Views
            const dailyView = document.getElementById('daily-view');
            const monthlyView = document.getElementById('monthly-view');
            const yearlyView = document.getElementById('yearly-view');
            const configView = document.getElementById('config-view');

            // Daily View Elements
            const dailyDatePicker = document.getElementById('daily-date-picker');
            const dailyTotalIncomeEl = document.getElementById('daily-total-income');
            const dailyTotalExpenseEl = document.getElementById('daily-total-expense');
            const dailyBalanceEl = document.getElementById('daily-balance');
            const dailyTransactionListEl = document.getElementById('daily-transaction-list');
            const printDailyReportBtn = document.getElementById('print-daily-report-btn');

            // Monthly View Elements
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const currentMonthYearEl = document.getElementById('current-month-year');
            const monthlyTotalIncomeEl = document.getElementById('monthly-total-income');
            const monthlyTotalExpenseEl = document.getElementById('monthly-total-expense');
            const monthlyBalanceEl = document.getElementById('monthly-balance');
            const monthlyTransactionListEl = document.getElementById('monthly-transaction-list');
            const printMonthlyReportBtn = document.getElementById('print-monthly-report-btn');

            // Yearly View Elements
            const prevYearBtn = document.getElementById('prev-year-btn');
            const nextYearBtn = document.getElementById('next-year-btn');
            const currentYearEl = document.getElementById('current-year');
            const printYearlyReportBtn = document.getElementById('print-yearly-report-btn');

            // --- Modal Elements ---
            const alertModal = document.getElementById('alert-modal');
            const alertMessageEl = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessageEl = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            let confirmCallback = null;

            // --- Utility Functions ---
            const formatCurrency = (num) => num.toLocaleString('th-TH', {minimumFractionDigits: 2});
            const toISODateString = (date) => date.toISOString().split('T')[0];
            const formatThaiDate = (date) => new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

            // --- Modal Functions ---
            function showAlert(message) { alertMessageEl.textContent = message; alertModal.classList.remove('hidden'); }
            function showConfirmModal(message, onConfirm) { confirmMessageEl.textContent = message; confirmCallback = onConfirm; confirmModal.classList.remove('hidden'); }
            alertOkBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
            confirmCancelBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
            confirmOkBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); confirmModal.classList.add('hidden'); });

            // --- Authentication & Data Fetching ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    userIdEl.textContent = user.uid;
                    listenToCategories();
                    listenToTransactions();
                } else {
                    signInAnonymously(auth).catch((error) => { console.error("Anonymous sign-in failed:", error); loadingOverlay.classList.add('hidden'); showAlert(`การเข้าสู่ระบบล้มเหลว: ${error.message}`); });
                }
            });

            function listenToCategories() {
                if (!currentUser) return;
                const categoriesRef = ref(db, `users/${currentUser.uid}/categories`);
                onValue(categoriesRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const dbCategories = snapshot.val();
                        categories.income = Array.isArray(dbCategories.income) && dbCategories.income.length > 0 ? dbCategories.income : ['เงินเดือน', 'รายได้เสริม'];
                        categories.expense = Array.isArray(dbCategories.expense) && dbCategories.expense.length > 0 ? dbCategories.expense : ['อาหาร', 'เดินทาง', 'ที่อยู่อาศัย', 'ของใช้ส่วนตัว', 'บันเทิง'];
                    } else {
                        set(categoriesRef, categories).catch(error => showAlert(`เกิดข้อผิดพลาดในการตั้งค่าหมวดหมู่เริ่มต้น: ${error.message}.`));
                    }
                    updateUI();
                    renderConfigLists();
                }, (error) => { showAlert(`เกิดข้อผิดพลาดในการอ่านข้อมูลหมวดหมู่: ${error.message}.`); });
            }

            function listenToTransactions() {
                if (!currentUser) return;
                const transactionsRef = ref(db, `users/${currentUser.uid}/transactions`);
                onValue(transactionsRef, (snapshot) => {
                    const data = snapshot.val();
                    allTransactions = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                    allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    updateUI();
                    loadingOverlay.classList.add('hidden');
                }, (error) => { loadingOverlay.classList.add('hidden'); showAlert(`เกิดข้อผิดพลาดในการอ่านข้อมูลธุรกรรม: ${error.message}.`); });
            }

            // --- Main UI Update Function ---
            function updateUI() {
                if (!currentUser) return;
                const activeNav = document.querySelector('nav button.bg-blue-500');
                if (!activeNav) return;

                switch (activeNav.id) {
                    case 'nav-daily': updateDailyView(); break;
                    case 'nav-monthly': updateMonthlyView(); break;
                    case 'nav-yearly': updateYearlyView(); break;
                }
                updateCategoryDropdowns();
            }

            // --- View Update Functions ---
            function updateDailyView() {
                dailyDatePicker.value = toISODateString(new Date(dailyDatePicker.value || new Date()));
                const dailyTransactions = allTransactions.filter(t => t.date === dailyDatePicker.value);
                renderTransactionList(dailyTransactions, dailyTransactionListEl);
                updateSummary(dailyTransactions, dailyTotalIncomeEl, dailyTotalExpenseEl, dailyBalanceEl);
            }

            function updateMonthlyView() {
                const month = monthlyDate.toLocaleString('th-TH', { month: 'long' });
                const year = monthlyDate.getFullYear() + 543;
                currentMonthYearEl.textContent = `${month} พ.ศ. ${year}`;
                dateInput.value = toISODateString(monthlyDate);

                const targetYear = monthlyDate.getFullYear();
                const targetMonth = monthlyDate.getMonth() + 1; // 1-12

                const monthlyTransactions = allTransactions.filter(t => {
                    const [tYear, tMonth] = t.date.split('-').map(Number);
                    return tYear === targetYear && tMonth === targetMonth;
                });

                renderTransactionList(monthlyTransactions, monthlyTransactionListEl);
                updateSummary(monthlyTransactions, monthlyTotalIncomeEl, monthlyTotalExpenseEl, monthlyBalanceEl);
                updateExpenseChart(monthlyTransactions);
            }

            function updateYearlyView() {
                currentYearEl.textContent = `สรุปปี ${yearlyDate + 543}`;
                const yearlyTransactions = allTransactions.filter(t => new Date(t.date).getFullYear() === yearlyDate);
                renderYearlySummaryTable(yearlyTransactions);
            }

            // --- Helper & Rendering Functions ---
            function renderTransactionList(transactions, containerEl) {
                containerEl.innerHTML = '';
                if (transactions.length === 0) {
                    containerEl.innerHTML = '<p class="text-gray-500 text-center py-8">ไม่มีรายการ</p>';
                    return;
                }
                transactions.forEach(t => {
                    const item = document.createElement('div');
                    const amountClass = t.type === 'income' ? 'text-green-600' : 'text-red-600';
                    const sign = t.type === 'income' ? '+' : '-';
                    item.className = 'flex justify-between items-center p-3 rounded-lg hover:bg-gray-50';
                    item.innerHTML = `<div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center ${t.type === 'income' ? 'bg-green-100' : 'bg-red-100'} no-print"><span class="text-xl">${t.type === 'income' ? '💰' : '💸'}</span></div><div><p class="font-semibold">${t.description}</p><p class="text-sm text-gray-500">${t.category} &bull; ${formatThaiDate(t.date)}</p></div></div><div class="text-right"><p class="font-bold text-lg ${amountClass}">${sign}${formatCurrency(parseFloat(t.amount))}</p><div><button class="edit-btn text-blue-500 hover:underline text-sm mr-2" data-id='${t.id}'>แก้ไข</button><button class="delete-btn text-red-500 hover:underline text-sm" data-id='${t.id}'>ลบ</button></div></div>`;
                    containerEl.appendChild(item);
                });
            }

            function updateSummary(transactions, incomeEl, expenseEl, balanceEl) {
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const balance = income - expense;
                incomeEl.textContent = formatCurrency(income);
                expenseEl.textContent = formatCurrency(expense);
                balanceEl.textContent = formatCurrency(balance);
            }

            function updateExpenseChart(transactions) {
                const ctx = document.getElementById('expense-chart').getContext('2d');
                const expenseData = transactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + parseFloat(t.amount); return acc; }, {});
                const labels = Object.keys(expenseData);
                const data = Object.values(expenseData);
                if (expenseChart) expenseChart.destroy();
                const noDataMessage = ctx.canvas.parentNode.querySelector('.no-data-message');
                if (noDataMessage) noDataMessage.remove();
                if (labels.length === 0) {
                    ctx.canvas.style.display = 'none';
                    const p = document.createElement('p');
                    p.className = 'no-data-message text-center text-gray-500 py-10';
                    p.textContent = 'ไม่มีข้อมูลรายจ่ายสำหรับสร้างกราฟ';
                    ctx.canvas.parentNode.appendChild(p);
                    return;
                }
                ctx.canvas.style.display = 'block';
                expenseChart = new Chart(ctx, { type: 'pie', data: { labels: labels, datasets: [{ label: 'รายจ่าย', data: data, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(c.parsed)}` } } } } });
            }

            function updateCategoryDropdowns(type = 'expense') {
                const options = categories[type]?.map(cat => `<option value="${cat}">${cat}</option>`).join('') || '';
                categorySelect.innerHTML = options;
                const editCategorySelect = document.getElementById('edit-category');
                const editType = document.getElementById('edit-transaction-type').value;
                const editOptions = categories[editType]?.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                if (editCategorySelect) editCategorySelect.innerHTML = editOptions || '';
            }

            function renderConfigLists() {
                const incomeList = document.getElementById('income-category-list');
                const expenseList = document.getElementById('expense-category-list');
                incomeList.innerHTML = categories.income.map(cat => `<li class="flex justify-between items-center p-2 bg-gray-100 rounded"><span>${cat}</span><button data-type="income" data-name="${cat}" class="delete-category-btn text-red-500 hover:text-red-700">ลบ</button></li>`).join('');
                expenseList.innerHTML = categories.expense.map(cat => `<li class="flex justify-between items-center p-2 bg-gray-100 rounded"><span>${cat}</span><button data-type="expense" data-name="${cat}" class="delete-category-btn text-red-500 hover:text-red-700">ลบ</button></li>`).join('');
            }

            function renderYearlySummaryTable(transactions) {
                const tableBody = document.getElementById('yearly-summary-table');
                const months = Array.from({length: 12}, (_, i) => i);
                let totalIncome = 0, totalExpense = 0;
                tableBody.innerHTML = '';
                months.forEach(month => {
                    const monthName = new Date(yearlyDate, month).toLocaleString('th-TH', { month: 'long' });
                    const monthTransactions = transactions.filter(t => new Date(t.date).getMonth() === month);
                    const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                    const expense = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                    totalIncome += income; totalExpense += expense;
                    const balance = income - expense;
                    const row = `<tr><td class="border-t py-2 px-4">${monthName}</td><td class="border-t py-2 px-4 text-right text-green-600">${formatCurrency(income)}</td><td class="border-t py-2 px-4 text-right text-red-600">${formatCurrency(expense)}</td><td class="border-t py-2 px-4 text-right font-semibold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(balance)}</td></tr>`;
                    tableBody.innerHTML += row;
                });
                document.getElementById('yearly-total-income').textContent = formatCurrency(totalIncome);
                document.getElementById('yearly-total-expense').textContent = formatCurrency(totalExpense);
                const totalBalance = totalIncome - totalExpense;
                const yearlyBalanceEl = document.getElementById('yearly-balance');
                yearlyBalanceEl.textContent = formatCurrency(totalBalance);
                yearlyBalanceEl.className = `py-2 px-4 text-right font-bold ${totalBalance >= 0 ? 'text-blue-700' : 'text-red-700'}`;
            }

            // --- Event Handlers ---
            transactionForm.addEventListener('submit', (e) => { e.preventDefault(); if (!currentUser) return; const newTransaction = { type: document.getElementById('transaction-type').value, description: document.getElementById('description').value, amount: parseFloat(document.getElementById('amount').value), category: document.getElementById('category').value, date: document.getElementById('date').value, createdAt: new Date().toISOString() }; push(ref(db, `users/${currentUser.uid}/transactions`), newTransaction).then(() => transactionForm.reset()).catch(err => showAlert(`Error adding transaction: ${err.message}`)); });
            transactionTypeSelect.addEventListener('change', (e) => updateCategoryDropdowns(e.target.value));
            document.getElementById('edit-transaction-type').addEventListener('change', (e) => updateCategoryDropdowns(e.target.value));

            document.querySelector('#main-content').addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = e.target.closest('.flex.justify-between').querySelector('.edit-btn').dataset.id;
                    showConfirmModal('คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?', () => { remove(ref(db, `users/${currentUser.uid}/transactions/${id}`)); });
                }
                if (e.target.classList.contains('edit-btn')) {
                    const id = e.target.dataset.id;
                    const transaction = allTransactions.find(t => t.id === id);
                    if (transaction) showEditModal(transaction);
                }
            });

            const editModal = document.getElementById('edit-modal');
            function showEditModal(transaction) { document.getElementById('edit-id').value = transaction.id; document.getElementById('edit-transaction-type').value = transaction.type; updateCategoryDropdowns(transaction.type); document.getElementById('edit-description').value = transaction.description; document.getElementById('edit-amount').value = transaction.amount; document.getElementById('edit-category').value = transaction.category; document.getElementById('edit-date').value = transaction.date; editModal.classList.remove('hidden'); }
            document.getElementById('cancel-edit').addEventListener('click', () => editModal.classList.add('hidden'));
            document.getElementById('edit-form').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('edit-id').value; const updates = { type: document.getElementById('edit-transaction-type').value, description: document.getElementById('edit-description').value, amount: parseFloat(document.getElementById('edit-amount').value), category: document.getElementById('edit-category').value, date: document.getElementById('edit-date').value }; update(ref(db, `users/${currentUser.uid}/transactions/${id}`), updates).then(() => editModal.classList.add('hidden')).catch(err => showAlert(`Error updating transaction: ${err.message}`)); });

            document.getElementById('add-income-category-form').addEventListener('submit', (e) => { e.preventDefault(); const newCat = document.getElementById('new-income-category').value.trim(); if (newCat && !categories.income.includes(newCat)) { set(ref(db, `users/${currentUser.uid}/categories/income`), [...categories.income, newCat]); } e.target.reset(); });
            document.getElementById('add-expense-category-form').addEventListener('submit', (e) => { e.preventDefault(); const newCat = document.getElementById('new-expense-category').value.trim(); if (newCat && !categories.expense.includes(newCat)) { set(ref(db, `users/${currentUser.uid}/categories/expense`), [...categories.expense, newCat]); } e.target.reset(); });
            configView.addEventListener('click', (e) => { if (e.target.classList.contains('delete-category-btn')) { const type = e.target.dataset.type; const name = e.target.dataset.name; showConfirmModal(`คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่ "${name}"?`, () => { set(ref(db, `users/${currentUser.uid}/categories/${type}`), categories[type].filter(cat => cat !== name)); }); } });

            // --- Navigation and View Handlers ---
            dailyDatePicker.addEventListener('change', (e) => { updateDailyView(); });
            prevMonthBtn.addEventListener('click', () => { monthlyDate.setMonth(monthlyDate.getMonth() - 1); updateMonthlyView(); });
            nextMonthBtn.addEventListener('click', () => { monthlyDate.setMonth(monthlyDate.getMonth() + 1); updateMonthlyView(); });
            prevYearBtn.addEventListener('click', () => { yearlyDate--; updateYearlyView(); });
            nextYearBtn.addEventListener('click', () => { yearlyDate++; updateYearlyView(); });

            function switchView(viewToShow, navToActivate) {
                [dailyView, monthlyView, yearlyView, configView].forEach(v => v.classList.add('hidden'));
                [navDaily, navMonthly, navYearly, navConfig].forEach(n => n.classList.remove('bg-blue-500', 'text-white'));
                viewToShow.classList.remove('hidden');
                navToActivate.classList.add('bg-blue-500', 'text-white');
                updateUI();
            }

            navDaily.addEventListener('click', () => switchView(dailyView, navDaily));
            navMonthly.addEventListener('click', () => switchView(monthlyView, navMonthly));
            navYearly.addEventListener('click', () => switchView(yearlyView, navYearly));
            navConfig.addEventListener('click', () => switchView(configView, navConfig));

            // --- Print Handlers ---
            const printArea = document.getElementById('print-area');

            function generateReportHTML(title, transactions) {
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const balance = income - expense;

                let transactionRows = transactions.length > 0 ? transactions.map(t => `
                    <tr class="border-b">
                        <td class="p-2">${formatThaiDate(t.date)}</td>
                        <td class="p-2">${t.description}</td>
                        <td class="p-2">${t.category}</td>
                        <td class="p-2 text-right ${t.type === 'income' ? 'text-green-600' : ''}">${t.type === 'income' ? formatCurrency(t.amount) : '-'}</td>
                        <td class="p-2 text-right ${t.type === 'expense' ? 'text-red-600' : ''}">${t.type === 'expense' ? formatCurrency(t.amount) : '-'}</td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="text-center p-4 text-gray-500">ไม่มีรายการ</td></tr>';

                return `
                    <div class="p-4">
                        <h1 class="text-2xl font-bold text-center mb-2">${title}</h1>
                        <p class="text-center text-gray-600 mb-6">สร้างเมื่อ: ${formatThaiDate(new Date())}</p>
                        <div class="grid grid-cols-3 gap-4 text-center mb-6 border-y py-4">
                            <div><p class="text-lg">รายรับรวม</p><p class="text-2xl font-bold text-green-600">${formatCurrency(income)}</p></div>
                            <div><p class="text-lg">รายจ่ายรวม</p><p class="text-2xl font-bold text-red-600">${formatCurrency(expense)}</p></div>
                            <div><p class="text-lg">คงเหลือ</p><p class="text-2xl font-bold text-blue-600">${formatCurrency(balance)}</p></div>
                        </div>
                        <h2 class="text-xl font-semibold mb-4">รายการทั้งหมด</h2>
                        <table class="w-full text-left">
                            <thead><tr class="bg-gray-200"><th class="p-2">วันที่</th><th class="p-2">คำอธิบาย</th><th class="p-2">หมวดหมู่</th><th class="p-2 text-right">รายรับ</th><th class="p-2 text-right">รายจ่าย</th></tr></thead>
                            <tbody>${transactionRows}</tbody>
                        </table>
                    </div>
                `;
            }

            function printReport(title, transactions) {
                printArea.innerHTML = generateReportHTML(title, transactions);
                printArea.classList.remove('hidden');
                window.print();
                printArea.classList.add('hidden');
            }

            printDailyReportBtn.addEventListener('click', () => {
                const title = `รายงานสรุปประจำวันที่ ${formatThaiDate(dailyDatePicker.value)}`;
                const transactions = allTransactions.filter(t => t.date === dailyDatePicker.value);
                printReport(title, transactions);
            });

            printMonthlyReportBtn.addEventListener('click', () => {
                const title = `รายงานสรุปประจำเดือน ${monthlyDate.toLocaleString('th-TH', { month: 'long', year: 'numeric' })}`;
                const targetYear = monthlyDate.getFullYear();
                const targetMonth = monthlyDate.getMonth() + 1;
                const transactions = allTransactions.filter(t => {
                    const [tYear, tMonth] = t.date.split('-').map(Number);
                    return tYear === targetYear && tMonth === targetMonth;
                });
                printReport(title, transactions);
            });

            printYearlyReportBtn.addEventListener('click', () => {
                const title = `รายงานสรุปประจำปี พ.ศ. ${yearlyDate + 543}`;
                const transactions = allTransactions.filter(t => new Date(t.date).getFullYear() === yearlyDate);
                printReport(title, transactions);
            });

            // Initial Load
            function initializeAppView() {
                dateInput.value = toISODateString(new Date());
                dailyDatePicker.value = toISODateString(new Date());
                switchView(monthlyView, navMonthly);
            }
            initializeAppView();
        </script>
    </body>
    </html>

</details>